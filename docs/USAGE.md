# btc-signal-bot 利用ガイド

## 対応プラットフォーム

| プラットフォーム | 対応状況 |
|------------------|----------|
| TUI (ターミナル) | 対応 (リアルタイムチャート + シグナル監視) |
| Discord | 対応 (コマンド + 自動検出 + シグナル配信) |
| Telegram | 対応 (コマンド + シグナル配信) |

任意の組み合わせで利用可能。

## TUI ダッシュボードでの使い方

### 起動

```bash
npm start -- --tui
```

### キーバインド

| キー | 操作 |
|------|------|
| `1`-`8` | タイムフレーム切替 (1m, 3m, 5m, 15m, 30m, 1h, 4h, 1d) |
| `TAB` | タイムフレーム順送り |
| `S` | 監視銘柄切替 (TRADE_SYMBOLS 設定時) |
| `q` / `ESC` | 終了 |

### 画面構成

- **チャート** (左上): 価格ライン + SMA5 (シアン) + SMA20 (マゼンタ)
- **ステータス** (右上): 現在価格、高値/安値、出来高、RSI、タイムフレーム、シグナル数
- **タイムフレーム** (右中): 選択中のタイムフレーム
- **シグナル履歴** (左下): 直近のBUY/SELLシグナル一覧
- **ログ** (右下): 操作ログ、エラーメッセージ

## Discord での使い方

### Bot をサーバーに追加

1. Discord Developer Portal で Bot を作成
2. OAuth2 URL で bot scope + Send/Read 権限を設定
3. URL にアクセスしてサーバーに招待
4. Bot tab で Message Content Intent を ON にする

### コマンド

| コマンド | 説明 |
|----------|------|
| `!ping` | 疎通確認 |
| `!price [通貨]` | 価格表示 (例: `!price ETH`) |
| `!prices` | 全通貨の価格一覧 |
| `!status` | Bot ステータス (uptime, シグナル数, サブスクライバー数) |
| `!history` | 直近シグナル一覧 (最大5件) |
| `!timeframe [tf]` | タイムフレーム変更 (例: `!timeframe 1h`) |
| `!subscribe` | サブスク登録 ($5/月、Stripe 決済リンク発行) |
| `!balance` | 資産状況 (管理者のみ) |
| `!trade buy [通貨] [数量]` | 買い注文 (管理者のみ) |
| `!trade sell [通貨] [数量]` | 売り注文 (管理者のみ) |

**トレードコマンド例:**

```
!trade buy              → デフォルト通貨をデフォルト数量で購入
!trade buy ETH          → ETH/JPY をコイン別設定数量で購入
!trade buy ETH 0.5      → ETH/JPY を 0.5 ETH 購入
!trade sell XRP 100     → XRP/JPY を 100 XRP 売却
!trade buy 0.5          → デフォルト通貨を 0.5 購入
```

### 自動検出キーワード

メッセージに以下が含まれると自動でトレードを実行 (**管理者のみ**)。
通貨名がメッセージに含まれる場合、その通貨で取引される (例: "ETH 買い" → ETH/JPY)。

| キーワード | 方向 |
|------------|------|
| 🚀 / buy / long / 入 / 買い | BUY |
| sell / short / 出 / 売り | SELL |

### シグナル配信

`DISCORD_SIGNAL_CHANNEL_ID` を設定すると、シグナルと日次サマリーが自動でそのチャンネルに投稿される。

## Telegram での使い方

### Bot を追加

1. Telegram で Bot を検索して開く
2. `/start` を送信して登録

### コマンド

| コマンド | 説明 |
|----------|------|
| `/start` | ウェルカムメッセージ |
| `/price [通貨]` | 価格表示 (例: `/price ETH`) |
| `/prices` | 全通貨の価格一覧 |
| `/trade buy/sell [通貨] [数量]` | トレード実行 (管理者のみ、例: `/trade buy ETH 0.5`) |
| `/balance` | 資産状況 (管理者のみ) |
| `/status` | Bot ステータス (uptime, シグナル数, サブスクライバー数) |
| `/history` | 直近シグナル一覧 (最大5件) |
| `/timeframe [tf]` | タイムフレーム変更 (例: `/timeframe 1h`) |
| `/subscribe` | サブスク登録 ($5/月、Stripe 決済リンク発行) |
| `/help` | ヘルプ |

### テキストでのトレード

Discord と同様、メッセージ内の BUY/SELL キーワードを自動検出してトレードを実行 (**管理者のみ**)。
通貨名がメッセージに含まれる場合、その通貨で取引される (例: "ETH 買い" → ETH/JPY)。

### シグナル配信

`TELEGRAM_CHANNEL_ID` を設定すると、シグナルと日次サマリーが自動でそのチャンネルに投稿される。

## トレード権限

トレード実行は管理者のみに制限可能。

| 環境変数 | 説明 |
|----------|------|
| `ADMIN_DISCORD_IDS` | トレード許可する Discord ユーザー ID (カンマ区切り) |
| `ADMIN_TELEGRAM_IDS` | トレード許可する Telegram ユーザー ID (カンマ区切り) |

- ID を設定 → そのユーザーのみトレード可能
- 未設定 (空) → 全ユーザーがトレード可能
- シグナル閲覧 (`!price`, `/price` 等) は全ユーザーに開放

## レート制限

コマンドの連打を防止するレート制限機能あり。

| 環境変数 | デフォルト | 説明 |
|----------|-----------|------|
| `RATE_LIMIT_WINDOW` | 60000 (1分) | 制限ウィンドウ (ms) |
| `RATE_LIMIT_MAX` | 10 | ウィンドウ内の最大リクエスト数 |

制限に達すると「⏳ レート制限中です。しばらくお待ちください。」と返される。

## シグナルの読み方

シグナルは以下のフォーマットで配信される:

```
#ETHSignal シグナル

方向: BUY
通貨: ETH/JPY
価格: ¥450,000
ターゲット: ¥463,500
ストップロス: ¥441,000
リスク: 1%
強度: 5/6

根拠:
  - RSI 28.5 (売られすぎ)
  - SMA ゴールデンクロス
  - 1h足でも同方向

自動トレード: 約定 0.05 @¥450,100

2026-02-17T12:00:00.000Z
```

| 項目 | 説明 |
|------|------|
| 方向 | BUY (買い) / SELL (売り) |
| 通貨 | 対象通貨ペア (BTC/JPY, ETH/JPY 等) |
| 価格 | シグナル発生時の価格 |
| ターゲット | 利確目標価格 (BUY: +3%, SELL: -3%) |
| ストップロス | 損切り価格 (BUY: -2%, SELL: +2%) |
| リスク | 推奨リスク割合 |
| 強度 | シグナルの確信度 (最大6) |
| 根拠 | シグナル判定に使われたテクニカル指標の根拠 |
| 自動トレード | AUTO_TRADE=true の場合のみ表示。約定結果または失敗理由 |

### 判定に使われる指標

| 指標 | BUY 条件 | SELL 条件 |
|------|----------|-----------|
| RSI (14) | < 30 (売られすぎ) / < 40 (低め) | > 70 (買われすぎ) / > 60 (高め) |
| SMA クロス | ゴールデンクロス (SMA5 > SMA20) | デスクロス (SMA5 < SMA20) |
| トレンド位置 | 価格 > SMA5 > SMA20 | 価格 < SMA5 < SMA20 |
| 1h 足確認 | 1h 足でも同方向 | 1h 足でも同方向 |

## 日次サマリー

24時間ごとに以下のサマリーが自動配信される:

```
#CryptoSignals 日次サマリー

--- BTC/JPY ---
価格: ¥10,200,000
24h High: ¥10,350,000
24h Low: ¥10,050,000
シグナル: BUY 2 / SELL 1

--- ETH/JPY ---
価格: ¥380,000
...

合計シグナル: 5
```

## サブスクリプション

### プラン

| プラン | 価格 | 内容 |
|--------|------|------|
| Monthly | $5/月 | BTC シグナル全配信 (Discord + Telegram) |

### 登録方法

1. Discord で `!subscribe` / Telegram で `/subscribe` を送信
2. 決済リンクが送られる (Stripe Checkout)
3. カード情報を入力して決済完了
4. サブスクリプションが有効化

## セットアップ (開発者向け)

```bash
git clone https://github.com/hiroyafushimi/earn-btc-signal-bot.git
cd earn-btc-signal-bot
npm i
cp config/.env.example .env
# .env を編集してトークン・APIキーを設定
npm start
```

詳細は [README.md](../README.md) および [開発ガイド](GUIDE.md) を参照。

## コイン別取引量設定

各コインの価格が大きく異なるため、コインごとに取引量を設定できる。

```
# .env
PROCESSING_AMOUNT=0.001          # デフォルト（全コイン共通）
PROCESSING_AMOUNT_BTC=0.001      # BTC: 0.001 BTC
PROCESSING_AMOUNT_ETH=0.05       # ETH: 0.05 ETH
PROCESSING_AMOUNT_XRP=100        # XRP: 100 XRP
PROCESSING_AMOUNT_SOL=1          # SOL: 1 SOL
PROCESSING_AMOUNT_DOGE=1000      # DOGE: 1000 DOGE
```

`PROCESSING_AMOUNT_{コイン名}` が未設定のコインは `PROCESSING_AMOUNT` のデフォルト値が使われる。

## 自動トレード

シグナルの強度が閾値以上の場合、自動で注文を実行する機能。

### 設定

```
# .env
AUTO_TRADE=false                 # true で有効化 (デフォルト: 無効)
AUTO_TRADE_MIN_STRENGTH=4        # 最低シグナル強度 (1-6、4以上推奨)
AUTO_TRADE_SYMBOLS=ETH,XRP,SOL   # 対象コイン限定 (空=全コイン)
```

### 動作フロー

1. シグナル生成 (強度が閾値以上)
2. 対象コインか確認 (AUTO_TRADE_SYMBOLS)
3. コイン別取引量で成行注文を実行
4. 結果をシグナル履歴に記録
5. 結果を Discord/Telegram 通知に含めて配信

### 安全設計

- `AUTO_TRADE=false` がデフォルト（明示的に有効化が必要）
- シグナルクールダウン（同方向は5分間隔）が自動トレードにも適用
- `AUTO_TRADE_SYMBOLS` で対象コインを限定可能（BTC は手動、アルトコインは自動等）
- 成行注文はリトライしない（二重注文防止）
- 失敗時はエラーをログに記録し、通知にも失敗理由を表示

## 対応取引所

| 取引所 | 推奨 | 備考 |
|--------|------|------|
| bitbank | 推奨 | 日本の取引所。44 JPY ペア対応、OHLCV サポート |
| Binance | - | グローバル。USDT ペア中心 |

`EXCHANGE` 環境変数で切替。ccxt 対応取引所であれば追加可能。
